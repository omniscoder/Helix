name: VeriBiota

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  veribiota-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Helix
        uses: actions/checkout@v4

      - name: Checkout VeriBiota
        uses: actions/checkout@v4
        with:
          repository: VeriBiota/VeriBiota
          ref: main
          path: veribiota_repo

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Helix (editable)
        run: |
          python -m pip install --upgrade pip
          pip install '.[dev]'

      - name: Generate micro DAGs for VeriBiota
        run: |
          python tests/veribiota/gen_crispr_micro.py
          python tests/veribiota/gen_prime_micro.py
          python tests/veribiota/gen_pcr_micro.py

      - name: Preflight lean-check metadata
        run: >
          helix veribiota preflight
          --checks veribiota_work/crispr_micro.lean-check.json
          veribiota_work/prime_micro.lean-check.json
          veribiota_work/pcr_micro.lean-check.json
          --payloads veribiota_work/crispr_micro.dag.json
          veribiota_work/prime_micro.dag.json
          veribiota_work/pcr_micro.dag.json

      - name: Export Lean suites into VeriBiota
        run: |
          helix veribiota export-suite \
            --inputs \
              veribiota_work/crispr_micro.dag.json \
              veribiota_work/prime_micro.dag.json \
              veribiota_work/pcr_micro.dag.json \
            --veribiota-root veribiota_repo \
            --module-path Biosim/VeriBiota/Helix/MicroSuite.lean \
            --module-name Biosim.VeriBiota.Helix.MicroSuite \
            --list-name allDags \
            --theorem-name helix_micro_all_checked \
            --skip-theorem

      - name: Install Lean + Lake
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Run VeriBiota proofs
        working-directory: veribiota_repo
        run: |
          lake build
          lake env lean Biosim/VeriBiota/Helix/MicroSuite.lean
